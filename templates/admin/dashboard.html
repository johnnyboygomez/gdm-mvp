<!-- templates/admin/dashboard.html -->
{% extends "admin/base.html" %}
{% block content %}
  <style>
    .step-cell {
      text-align: center;
      padding: 8px;
    }
    .step-cell.has-data {
      background-color: #e8f5e8;
      font-weight: bold;
    }
    .step-cell.no-data-future {
      background-color: #f5f5f5;
      color: #999;
    }
    .step-cell.no-data-critical {
      background-color: red;
      color: white;
      font-weight: bold;
    }
    .step-cell.no-data-warning {
      background-color: orangered;
      color: white;
      font-weight: bold;
    }
    .step-cell.no-data-alert {
      background-color: orange;
      color: white;
      font-weight: bold;
    }
    .step-cell.no-data-caution {
      background-color: khaki;
      color: black;
    }
    .dashboard-table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed; 
    }
    .dashboard-table th {
      background-color: #f0f0f0;
      padding: 8px;
      text-align: center;
    }
    .dashboard-table th:first-child,
    .dashboard-table td:first-child {
      width: 220px; /* ~44 characters at typical font size */
      text-align: left;
      padding-left: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .error-cell {
      text-align: center;
      padding: 8px;
      width: 80px;
    }
    .error-icon {
      color: #dc3545;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
    }
    .error-icon:hover {
      color: #b02a37;
    }
    .no-error {
      color: #28a745;
      font-size: 16px;
    }
  </style>
  <h1>Custom Admin Dashboard - Blocks by Day</h1>
 
  <hr>
  {% for group in grouped_participants_with_headers %}
    {% if group.participants %}
      {% with block_date=group.block_date days=group.days %}
        <div class="dashboard-block" style="margin-bottom:2em;">
          <h2>
            {% if days == 0 %}Today ({{ today|date:"Y-m-d" }})
            {% elif days == 1 %}Tomorrow ({{ today|add:"1"|date:"Y-m-d" }})
            {% else %}In {{ days }} days ({{ today|add:days|stringformat:"s"|date:"Y-m-d" }})
            {% endif %}
          </h2>

          <table class="dashboard-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Errors</th>
                {% for day in group.header_days %}
                  <th>{{ day|date:"D" }}<br><small>{{ day|date:"m/d" }}</small></th>
                {% endfor %}
                <th>Target Day<br><small>{{ block_date|date:"m/d" }}</small></th>
              </tr>
            </thead>
            <tbody>
              {% for p in group.participants %}
                <tr>
                   <td>
                     <a href="{% url 'participant_detail' p.participant_id %}" 
                        style="color: #007cba; text-decoration: none;">
                       {{ p.email }}
                     </a>
                   </td>
                   <td class="error-cell">
                     {% if p.has_errors %}
                       <a href="{% url 'participant_detail' p.participant_id %}" class="error-icon">
                         ✗
                       </a>
                     {% else %}
                       <span class="no-error">✓</span>
                     {% endif %}
                   </td>
                  {% for cell in p.steps_with_classes %}
                    <td class="step-cell {{ cell.class }}">
                      {{ cell.steps }}
                    </td>
                  {% endfor %}
                  <td class="step-cell {{ p.target_day_class }}">
  						{{ p.target_day_steps }}
					</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endwith %}
    {% else %}
      {% with block_date=group.block_date days=group.days %}
        <div class="dashboard-block" style="margin-bottom:2em;">
          <h2>
            {% if days == 0 %}Today ({{ today|date:"Y-m-d" }})
            {% elif days == 1 %}Tomorrow ({{ today|add:"1"|date:"Y-m-d" }})
            {% else %}In {{ days }} days ({{ today|add:days|stringformat:"s"|date:"Y-m-d" }})
            {% endif %}
          </h2>
          
          <table class="dashboard-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>Errors</th>
                {% for day in group.header_days %}
                  <th>{{ day|date:"D" }}<br><small>{{ day|date:"m/d" }}</small></th>
                {% endfor %}
                <th>Target Day<br><small>{{ block_date|date:"m/d" }}</small></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>No participants</td>
                <td class="error-cell">-</td>
                {% for day in group.header_days %}
                  <td class="step-cell no-data-future">-</td>
                {% endfor %}
                <td class="step-cell no-data-future">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      {% endwith %}
    {% endif %}
  {% empty %}
    <p>No upcoming participants with targets in the next 7 days.</p>
  {% endfor %}
<script>
function naturalCompare(a, b) {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
}
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.dashboard-block table tbody').forEach(tbody => {
    const rows = Array.from(tbody.querySelectorAll('tr'))
      .filter(row => !row.textContent.includes('No participants'));
    // Email is now the first column (index 0)
    rows.sort((a, b) => naturalCompare(
      a.cells[0].innerText, b.cells[0].innerText
    ));
    rows.forEach(row => tbody.appendChild(row));
  });
});
</script>
{% endblock %}